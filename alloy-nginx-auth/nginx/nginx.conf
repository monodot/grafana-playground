events {
    worker_connections 1024;
}

http {
    # Map incoming X-Example-Key header to valid tokens
    # If token is found in tokens.map, $client_name will contain the client name
    # If not found, $client_name will be empty
    map $http_x_example_key $client_name {
        default "";
        include /etc/nginx/tokens.map;
    }

    upstream alloy_otlp_grpc {
        server alloy:4317;
    }

    upstream alloy_otlp_http {
        server alloy:4318;
    }

    upstream alloy_prometheus {
        server alloy:9090;
    }

    server {
        listen 4317 http2;

        location / {
            if ($client_name = "") {
                return 401 "Unauthorized: Invalid or missing X-Example-Key header\n";
            }

            grpc_pass grpc://alloy_otlp_grpc;
            grpc_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            grpc_set_header X-Client-Name $client_name;
        }
    }

    server {
        listen 4318;

        location / {
            if ($client_name = "") {
                return 401 "Unauthorized: Invalid or missing X-Example-Key header\n";
            }

            proxy_pass http://alloy_otlp_http;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Client-Name $client_name;
        }
    }

    server {
        listen 9090;

        location /api/v1/metrics/write {
            if ($client_name = "") {
                return 401 "Unauthorized: Invalid or missing X-Example-Key header\n";
            }

            proxy_pass http://alloy_prometheus/api/v1/metrics/write;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Client-Name $client_name;
        }
    }
}
